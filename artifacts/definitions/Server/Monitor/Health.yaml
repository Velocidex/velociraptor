name: Server.Monitor.Health
description: |
  This is the main server health dashboard. It is shown on the
  homescreen and enabled by default on all new installs.

type: SERVER_EVENT

parameters:
  - name: Frequency
    description: Return stats every this many seconds.
    default: "15"

sources:
  # This artifact is populated by the frontend service from the total
  # of all frontend metrics.
  - name: Prometheus


reports:
  - type: SERVER_EVENT
    parameters:
      - name: Sample
        default: "4"

    template: |
      {{ define "CPU" }}
           SELECT * FROM sample(
             n=atoi(string=Sample),
             query={
               SELECT _ts as Timestamp,
                  CPUPercent,
                  MemoryUse / 1024 / 1024
               FROM source(source="Prometheus",
                           artifact="Server.Monitor.Health")
             })
      {{ end }}

      {{ define "CurrentConnections" }}
           SELECT * FROM sample(
             n=atoi(string=Sample),
             query={
               SELECT _ts as Timestamp,
                  client_comms_current_connections,
                  client_comms_concurrency
               FROM source(source="Prometheus",
                           artifact="Server.Monitor.Health")
            })
      {{ end }}

      ## Server status

      The following are total across all frontends.

      <span class="container">
        <span class="row">
          <span class="col-sm panel">
           CPU and Memory Utilization
           {{ Query "CPU" | LineChart "xaxis_mode" "time" "RSS.yaxis" 2 }}
          </span>
          <span class="col-sm panel">
           Currently Connected Clients
           {{ Query "CurrentConnections" | LineChart "xaxis_mode" "time" "RSS.yaxis" 2 }}
          </span>
        </span>
      </span>


      ## Users

      {{ Query "SELECT Name, Permissions FROM gui_users()" | Table }}
