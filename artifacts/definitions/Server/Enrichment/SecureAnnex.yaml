name: Server.Enrichment.SecureAnnex
author: Whitney Champion -- bsky.app/profile/whit.zip
description: |
  Submit an extension ID to the SecureAnnex API.

  https://app.secureannex.com/settings/api

  This is a rather simple artifact that can be called from within another artifact (such as one looking for installed Chrome extensions) to enrich the data made available by that artifact.

  Ex.

    `SELECT * from Artifact.Server.Enrichment.SecureAnnex(ID=$EXTENSION_ID,Version=$EXTENSION_VERSION)`


type: SERVER

parameters:
    - name: ID
      type: string
      description: The extension ID to submit to SecureAnnex.
      default:
    - name: Version
      type: string
      description: The extension version to submit to SecureAnnex
      default: 
    - name: ApiKey
      type: string
      description: The API key to submit to SecureAnnex.
      default: ''
    - name: ApiURL
      type: string
      description: The SecureAnnex API URL.
      default: https://api.secureannex.com/api/v0/vulnerabilities

sources:
  - query: |

        LET Data = SELECT parse_json(data=Content) AS SecureAnnexLookup
            FROM http_client(url=ApiURL + "?extension_id=" + ID + "&version=" + Version + "&page_size=100", headers=dict(`Accept`="application/json",`x-api-key`=ApiKey), method='GET')

        SELECT
            SecureAnnexLookup.component AS Component,
            SecureAnnexLookup.detection AS Detection,
            SecureAnnexLookup.extension_id AS ID,
            SecureAnnexLookup.file_path AS FilePath,
            SecureAnnexLookup.name AS Name,
            SecureAnnexLookup.npmname AS NPMName,
            SecureAnnexLookup.version AS Version,
            SecureAnnexLookup.vuln_version AS VulnVersion,
            SecureAnnexLookup.vulnerability AS _Vulnerability,
            SecureAnnexLookup.vulnerability.atOrAbove AS VulnerabilityAtOrAbove,
            SecureAnnexLookup.vulnerability.below AS VulnerabilityBelow,
            SecureAnnexLookup.vulnerability.identifiers AS VulnerabilityIdentifiers,
            SecureAnnexLookup.vulnerability.info as VulnerabilityInfo,
            SecureAnnexLookup.vulnerability.severity as VulnerabilitySeverity,
            SecureAnnexLookup AS _SecureAnnexLookup
        FROM Data
