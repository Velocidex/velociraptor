name: Server.Utils.DownloadBinaries
description: |
  This server side artifact downloads the external binary blobs we
  require into the server's public directory. We also update the
  inventory and the hashes.

  You need to run this artifact at least once after installation to
  populate the third party binary store. Many client side artifacts
  depend on this.

  Only some of these are enabled by default. To enable you can either
  change the artifact parameter when running it, or customize this
  artifact and collect the customized version.

type: SERVER

required_permissions:
  - SERVER_ADMIN

parameters:
  - name: binaryList
    type: csv
    default: |
      Tool,ServeLocally,URL,Filename
      Autorun_amd64,Y,https://live.sysinternals.com/tools/autorunsc64.exe,autorunsc_x64.exe
      Autorun_x86,Y,https://live.sysinternals.com/tools/autorunsc.exe,autorunsc_x86.exe
      WinPmem,Y,https://github.com/Velocidex/c-aff4/releases/download/v3.3.rc3/winpmem_v3.3.rc3.exe,winpmem_v3.3.rc3.exe
      Sysmon_x64,N,https://live.sysinternals.com/tools/sysmon64.exe,sysmon_x64.exe
      Sysmon_x86,N,https://live.sysinternals.com/tools/sysmon.exe,sysmon_x86.exe
      Bulk_Extractor,N,https://github.com/4n6ist/bulk_extractor-rec/releases/download/rec03/bulk_extractor-rec03_x64.zip,bulk_extractor.zip
      VelociraptorWindows,Y,https://github.com/Velocidex/velociraptor/releases/download/v0.4.5/velociraptor-v0.4.5-windows-amd64.exe,velociraptor-v0.4.5-windows-amd64.exe
      VelociraptorLinux,Y,https://github.com/Velocidex/velociraptor/releases/download/v0.4.5/velociraptor-v0.4.5-linux-amd64,velociraptor-v0.4.5-linux-amd64
      VelociraptorDarwin,Y,https://github.com/Velocidex/velociraptor/releases/download/v0.4.5/velociraptor-v0.4.5-darwin-amd64,velociraptor-v0.4.5-darwin-amd64

sources:
  - query: |
      LET _ <= SELECT *, inventory_add(tool=Tool, serve_locally=ServeLocally="Y",
          url=URL, filename=Filename) AS Added
      FROM parse_csv(filename=binaryList, accessor="data")

      SELECT * FROM inventory()
