name: Linux.RHEL.Packages
description: |
  Parse packages installed from dnf or yum
sources:
  - precondition: |
      SELECT OS From info() where OS = 'linux'

    query: |
        LET exec = SELECT * FROM foreach(row={
          SELECT grok(grok="%{DATA:Package}%{SPACE} %{DATA:Version}%{SPACE} %{GREEDYDATA:Repository}", data=Stdout) AS Parsed
          FROM execve(argv=cmd, sep="\n")
        }, column="Parsed")
        
        SELECT * FROM switch(
            a=exec(cmd=["sh","-c" ,"dnf --quiet list installed | tail -n +2 | xargs -n3 | column -t"]),
            b=exec(cmd=["sh","-c" ,"yum --quiet list installed | tail -n +2 | xargs -n3 | column -t"]),
            c={SELECT log(level="ERROR",message="Could not retrieve package list") FROM scope()}
            )
