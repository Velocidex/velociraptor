name: Custom.Linux.Ssh.PrivateKeys
description: |
  SSH Private keys can be either encrypted or unencrypted. Unencrypted
  private keys are more risky because an attacker can use them without
  needing to unlock them with a password.

  This artifact searches for private keys in the usual locations and
  also records if they are encrypted or not.
  
  Change the glob to /** if you would like to search the entire filesystem.
  Be aware, this is an expensive operation.

  ## references
  - https://attack.mitre.org/techniques/T1145/

precondition: SELECT OS From info() where OS = 'linux'

parameters:
  - name: MyGlob
    default: /*/*/.ssh/*

sources:
  - queries:
      - LET Hits = SELECT FullPath, read_file(filename=FullPath, length=10240) AS Data
        FROM glob(globs=MyGlob)
        WHERE Data =~ "BEGIN OPENSSH PRIVATE KEY"
        
      - LET DecodedFiles = SELECT FullPath,
            base64decode(
                string=parse_string_with_regex(
                    string=read_file(filename=FullPath), 
                    regex="(?sm)KEY-----(.+)-----END").g1) AS Decoded
        FROM Hits

      - SELECT FullPath, split(string=Decoded, sep="[\\x00\\s]+")[1] AS EncryptionType
        FROM DecodedFiles
