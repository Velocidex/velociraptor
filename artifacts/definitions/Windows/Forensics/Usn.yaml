name: Windows.Forensics.Usn
description: |
  NTFS is a journal filesystem. This means that it maintains a journal
  file where intended filesystem changes are written first, then the
  filesystem is changed. This journal is called the USN journal in NTFS.

  Velociraptor can parse the USN journal from the filesystem. This
  provides an indication of recent file changes. Typically the system
  maintains the journal of around 30mb and depending on system
  activity this can go back quite some time.

  Use this artifact to determine the times when a file was
  modified/added from the journal. This will be present even if the
  file was later removed.

parameters:
  - name: PathRegex
    description: A regex to match the entire path (you can watch a directory or a file type).
    default: .
  - name: ReasonSelector
    type: csv
    description: By default it filters for all Update Reasons (file create, deleted etc). Remove the Update Reasons you don't want to see
    default: |
      UpdateReason
      .
      BASIC_INFO_CHANGE
      CLOSE
      COMPRESSION_CHANGE
      DATA_EXTEND
      DATA_OVERWRITE
      DATA_TRUNCATION
      EA_CHANGE
      ENCRYPTION_CHANGE
      FILE_CREATE
      FILE_DELETE
      HARD_LINK_CHANGE
      INDEXABLE_CHANGE
      NAMED_DATA_EXTEND
      NAMED_DATA_OVERWRITE
      NAMED_DATA_TRUNCATION
      OBJECT_ID_CHANGE
      RENAME_NEW_NAME
      RENAME_OLD_NAME
      REPARSE_POINT_CHANGE
      SECURITY_CHANGE
      STREAM_CHANGE
  - name: Device
    description: The NTFS drive to watch
    default: C:\\

precondition: SELECT OS from info() where OS = "windows"

sources:
  - query: |
      SELECT * {
            SELECT * FROM ReasonSelector WHERE Reason =~ UpdateReason
         } as match
      FROM parse_usn(device=Device)
      WHERE FullPath =~ PathRegex AND match
