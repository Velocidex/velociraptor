Queries:
# Define a HTTP secret
- SELECT secret_add(
        name="TestHTTPSecret",
        type="HTTP Secrets",
        secret=dict(
          url="https://www.google.com/"
        )) AS Secret
  FROM scope()

# List all the secrets
- SELECT type_name, secrets FROM secrets()
  WHERE type_name =~ "HTTP"

# Try to use it - should get permission denied because the user was
# not assigned.
- SELECT * FROM http_client(secret="TestHTTPSecret")
- SELECT * FROM test_read_logs() WHERE NOT Log =~ "SELECT" AND Log =~ "permission"

# Give the user the permission
- SELECT secret_modify(name="TestHTTPSecret", type="HTTP Secrets",
    add_users=whoami())
  FROM scope()

# Should be able to access the url now. But - we do not reveal the URL!
- SELECT Url, Response FROM http_client(secret="TestHTTPSecret")

# Create a suborg
- LET _ <= org_create(name="MyOrg", org_id="ORGID")

# Can we access the secret in the suborg?
- SELECT * FROM query(org_id="ORGID", query={
    SELECT secret_modify(
       name="TestHTTPSecret", type="HTTP Secrets",
       add_users=whoami())
    FROM scope()
  })

# Secret is not found in the suborg
- SELECT * FROM test_read_logs() WHERE NOT Log =~ "SELECT" AND Log =~ "Secret Not Found"

# Mark the secret is visible to all orgs
# Give the user the permission
- SELECT secret_modify(name="TestHTTPSecret", type="HTTP Secrets",
    visible_to_all_orgs=TRUE) FROM scope()

# Try this again
- SELECT * FROM query(org_id="ORGID", query={
    SELECT secret_modify(
       name="TestHTTPSecret", type="HTTP Secrets",
       add_users=whoami())
    FROM scope()
  })

# Secret should be usable in the org
# Should be able to access the url now. But - we do not reveal the URL!
- SELECT * FROM query(org_id="ORGID", query={
    SELECT Url, Response FROM http_client(secret="TestHTTPSecret")
  })
