# Define a HTTP secret
Query: SELECT secret_add( name="TestHTTPSecret", type="HTTP Secrets", secret=dict( url="https://www.google.com/" )) AS Secret FROM scope()
Output: [
 {
  "Secret": "TestHTTPSecret"
 }
]

# List all the secrets
Query: SELECT type_name, secrets FROM secrets() WHERE type_name =~ "HTTP"
Output: [
 {
  "type_name": "HTTP Secrets",
  "secrets": [
   {
    "name": "TestHTTPSecret",
    "type_name": "HTTP Secrets",
    "description": "",
    "encrypted_secret": null,
    "secret": {},
    "users": [],
    "orgs": [],
    "visible_to_all_orgs": false
   }
  ]
 }
]

# Try to use it - should get permission denied because the user was
# not assigned.
Query: SELECT * FROM http_client(secret="TestHTTPSecret")
Output: []

Query: SELECT * FROM test_read_logs() WHERE NOT Log =~ "SELECT" AND Log =~ "permission"
Output: [
 {
  "Log": "Velociraptor: http_client: Permission Denied accessing secret TestHTTPSecret\n"
 }
]

# Give the user the permission
Query: SELECT secret_modify(name="TestHTTPSecret", type="HTTP Secrets", add_users=whoami()) FROM scope()
Output: [
 {
  "secret_modify(name=\"TestHTTPSecret\", type=\"HTTP Secrets\", add_users=whoami())": "TestHTTPSecret"
 }
]

# Should be able to access the url now. But - we do not reveal the URL!
Query: SELECT Url, Response FROM http_client(secret="TestHTTPSecret")
Output: [
 {
  "Url": "secret://TestHTTPSecret",
  "Response": 200
 }
]

# Create a suborg
Query: LET _ <= org_create(name="MyOrg", org_id="ORGID")
Output: []

# Can we access the secret in the suborg?
Query: SELECT * FROM query(org_id="ORGID", query={ SELECT secret_modify( name="TestHTTPSecret", type="HTTP Secrets", add_users=whoami()) FROM scope() })
Output: [
 {
  "secret_modify(name=\"TestHTTPSecret\", type=\"HTTP Secrets\", add_users=whoami())": "TestHTTPSecret"
 }
]

# Secret is not found in the suborg
Query: SELECT * FROM test_read_logs() WHERE NOT Log =~ "SELECT" AND Log =~ "Secret Not Found"
Output: []

# Mark the secret is visible to all orgs
# Give the user the permission
Query: SELECT secret_modify(name="TestHTTPSecret", type="HTTP Secrets", visible_to_all_orgs=TRUE) FROM scope()
Output: [
 {
  "secret_modify(name=\"TestHTTPSecret\", type=\"HTTP Secrets\", visible_to_all_orgs=TRUE)": "TestHTTPSecret"
 }
]

# Try this again
Query: SELECT * FROM query(org_id="ORGID", query={ SELECT secret_modify( name="TestHTTPSecret", type="HTTP Secrets", add_users=whoami()) FROM scope() })
Output: [
 {
  "secret_modify(name=\"TestHTTPSecret\", type=\"HTTP Secrets\", add_users=whoami())": "TestHTTPSecret"
 }
]

# Secret should be usable in the org
# Should be able to access the url now. But - we do not reveal the URL!
Query: SELECT * FROM query(org_id="ORGID", query={ SELECT Url, Response FROM http_client(secret="TestHTTPSecret") })
Output: [
 {
  "Url": "secret://TestHTTPSecret",
  "Response": 200
 }
]

