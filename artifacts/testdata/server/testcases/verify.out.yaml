# Basic verification of some artifacts.
Query: SELECT verify(artifact=Broken1) AS Broken1, verify(artifact=Broken2) AS Broken2, verify(artifact=Broken3) AS Broken3, verify(artifact=Warn1) AS Warn1 FROM scope()
Output: [
 {
  "Broken1": {
   "Artifact": "name: BrokenYaml\nsomeweirdfield: 1\n",
   "Permissions": null,
   "Errors": [
    "yaml: unmarshal errors:\n  line 2: field someweirdfield not found in type proto.Artifact"
   ],
   "Warnings": null,
   "Definitions": {}
  },
  "Broken2": {
   "Artifact": "name: BrokenQuery\nsources:\n- query: SELECT * FROM nosuchplugin()\n",
   "Permissions": null,
   "Errors": [
    "BrokenQuery: query: Unknown plugin nosuchplugin()"
   ],
   "Warnings": null,
   "Definitions": {}
  },
  "Broken3": {
   "Artifact": "name: BrokenSubArtifact\nsources:\n- query: SELECT * FROM Artifact.No.Such.Artifact()\n",
   "Permissions": null,
   "Errors": [
    "BrokenSubArtifact: query: Unknown artifact reference No.Such.Artifact"
   ],
   "Warnings": null,
   "Definitions": {}
  },
  "Warn1": {
   "Artifact": "name: WarnningExecve\nsources:\n- query: SELECT * FROM execve(argv=[\"ls\"])\n",
   "Permissions": [
    "EXECVE"
   ],
   "Errors": null,
   "Warnings": [
    "\u003cyellow\u003eSuggestion\u003c/\u003e: Add EXECVE to artifact's required_permissions or implied_permissions fields"
   ],
   "Definitions": {}
  }
 }
]

# Check the Server.Utils.ArtifactVerifier works on some bad
# artifacts. Filter out the absolute path to make test reproducible
Query: SELECT summary, artifacts, { SELECT *, basename(path=path) as path FROM results } AS results FROM Artifact.Server.Utils.ArtifactVerifier( SearchGlob=srcDir+"/artifacts/testdata/files/artifacts/*")
Output: [
 {
  "summary": {
   "total": 6,
   "passed": 4,
   "failed": 2,
   "warnings": 1
  },
  "artifacts": [
   "Caller",
   "Good",
   "Generic.Client.Info",
   "BrokenYaml",
   "BrokenQuery",
   "WarnningExecve"
  ],
  "results": [
   {
    "name": "Caller",
    "passed": true,
    "errors": [],
    "warnings": [],
    "path": "caller.yaml"
   },
   {
    "name": "Good",
    "passed": true,
    "errors": [],
    "warnings": [],
    "path": "good.yaml"
   },
   {
    "name": "Generic.Client.Info",
    "passed": true,
    "errors": [],
    "warnings": [],
    "path": "info.yaml"
   },
   {
    "name": "BrokenYaml",
    "passed": false,
    "errors": [
     "yaml: unmarshal errors:\n  line 2: field someweirdfield not found in type proto.Artifact"
    ],
    "warnings": [],
    "path": "invalid1.yaml"
   },
   {
    "name": "BrokenQuery",
    "passed": false,
    "errors": [
     "BrokenQuery: query: Unknown plugin nosuchplugin()"
    ],
    "warnings": [],
    "path": "invalid2.yaml"
   },
   {
    "name": "WarnningExecve",
    "passed": true,
    "errors": [],
    "warnings": [
     "\u003cyellow\u003eSuggestion\u003c/\u003e: Add EXECVE to artifact's required_permissions or implied_permissions fields"
    ],
    "path": "invalid3.yaml"
   }
  ]
 }
]

# Check the "disable_override" argument produces an error when overriding a built-in,
# but not when creating a new artifact when True is specified.
Query: SELECT verify(artifact=Override1, disable_override=True) AS Override1, verify(artifact=Override2, disable_override=True) AS Override2 FROM scope()
Output: [
 {
  "Override1": {
   "Artifact": "name: Generic.Client.Info\nsources:\n- query: SELECT * FROM scope()\n",
   "Permissions": null,
   "Errors": [
    "Unable to override built in artifact Generic.Client.Info"
   ],
   "Warnings": null,
   "Definitions": {}
  },
  "Override2": {
   "Artifact": "name: Override2\nsources:\n- query: SELECT * FROM scope()\n",
   "Permissions": null,
   "Errors": null,
   "Warnings": null,
   "Definitions": {}
  }
 }
]

